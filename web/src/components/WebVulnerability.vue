<template>
  <div>
    <a-card
      :style="{ width: '100%', height: tableHeight + 170 + 'px' }"
      :body-style="{ padding: 0 }"
    >
      <div slot="title">
        <font style="font-family: Apple Chancery, cursive;" size="+2">
          httpx report
        </font>
      </div>
      <div slot="extra" style="width: 1300px;">
        <a-input-search
          style="width: 1000px; margin-right: 30px;"
          v-model="searchWord"
          placeholder="Search"
          @search="search"
        ></a-input-search>
        <a-button type="primary" @click="copy">
          copy {{ pagination.total }} item links
        </a-button>
      </div>
      <a-table
        v-if="datas && datas.length"
        :defaultExpandAllRows="true"
        :data-source="datas"
        :scroll="{ y: tableHeight }"
        :pagination="pagination"
        rowKey="id"
        @expand="onExpand"
        :expandedRowKeys="expandedRowKeys"
      >
        <div
          slot="expandedRowRender"
          slot-scope="record"
          style="background-color: #fbfbfb; padding: 0px;"
        >
          <!-- 420px -->
          <div
            v-if="record.fingers != null && record.fingers.length > 0"
            hoverable
            style="
              overflow-y: auto;
              vertical-align: top;
              display: inline-block;
              width: 420px;
              height: 345px;
              margin-bottom: 0px;
              background-color: white;
            "
          >
            <ol hoverable style="background-color: white;">
              <li v-for="finger in record.fingers" :key="finger.id">
                <img
                  :src="finger.icon"
                  :alt="finger.icon"
                  style="width: 20px;"
                />
                <i v-if="finger.icon != ''">-</i>
                <a slot="title" :href="finger.website">{{ finger.name }}</a>
              </li>
            </ol>
          </div>
          <!-- 600px -->
          <a-card
            v-if="record.image != null && record.image.length > 0"
            hoverable
            :style="{
              'vertical-align': 'top',
              display: 'inline-block',
              width: '600px',
            }"
            @click="showScreenshot(record.image)"
          >
            <img
              v-if="record.image !== ''"
              slot="cover"
              alt="screenshot"
              :src="record.image"
              style="height: 345px; width: 600px;"
            />
          </a-card>
          <!-- width - 600 - 420 - 50 - 50 -->
          <a-card
            v-if="
              (record.fingers == null || record.fingers.length <= 0) &&
              (record.image == null || record.image.length <= 0)
            "
            hoverable
            :style="{
              'vertical-align': 'top',
              display: 'inline-block',
              width: width - 100 + 'px',
            }"
          >
            <pre class="response">{{ record.httpdump }}</pre>
          </a-card>
          <a-card
            v-else-if="(record.fingers == null || record.fingers.length <= 0) && (record.image != null && record.image.length > 0)"
            hoverable
            :style="{
              'vertical-align': 'top',
              display: 'inline-block',
              width: width - 600 - 100 + 'px',
            }"
          >
            <pre class="response">{{ record.httpdump }}</pre>
          </a-card>
          <a-card
            v-else-if="
              record.fingers != null &&
              record.fingers.length > 0 &&
              (record.image == null || record.image.length <= 0)
            "
            hoverable
            :style="{
              'vertical-align': 'top',
              display: 'inline-block',
              width: width - 420 - 100 + 'px',
            }"
          >
            <pre class="response">{{ record.httpdump }}</pre>
          </a-card>
          <a-card
            v-else
            hoverable
            :style="{
              'vertical-align': 'top',
              display: 'inline-block',
              width: width - 600 - 420 - 50 - 50 + 'px',
            }"
          >
            <pre class="response">{{ record.httpdump }}</pre>
          </a-card>
        </div>
        <a-table-column
          title="ID"
          key="id"
          width="90px"
          :customRender="(text, record, index) => index + 1"
          align="center"
        ></a-table-column>
        <a-table-column
          title="HOST"
          key="url"
          :sorter="(a, b) => a.url.localeCompare(b.url)"
        >
          <template slot-scope="record">
            <span
              style="
                display: inline-block;
                text-overflow: ellipsis;
                overflow: hidden !important;
                white-space: nowrap;
                width: 100%;
              "
            >
              <a
                :href="record.url"
                class="urls"
                style="display: inline-block; max-width: 50vw;"
                target="blank"
              >
                {{ record.url }}
              </a>
            </span>
          </template>
        </a-table-column>
        <a-table-column
          title="Title"
          key="title"
          :sorter="(a, b) => a.title.localeCompare(b.title)"
        >
          <template slot-scope="record">
            <span
              style="
                display: inline-block;
                text-overflow: ellipsis;
                overflow: hidden !important;
                white-space: nowrap;
                width: 100%;
              "
            >
              <a
                :href="record.url"
                class="urls"
                style="display: inline-block; max-width: 50vw;"
                @click.prevent.stop="window.open(record.url)"
              >
                {{ record.title }}
              </a>
            </span>
          </template>
        </a-table-column>
        <a-table-column
          title="StatusCode"
          key="statuscode"
          width="130px"
          :sorter="(a, b) => a.statuscode.localeCompare(b.statuscode)"
        >
          <template slot-scope="record">
            <font v-if="record.statuscode != 0">
              {{ record.statuscode }}
            </font>
          </template>
        </a-table-column>
        <a-table-column
          title="BodyLength"
          key="bodylength"
          width="140px"
          :sorter="(a, b) => a.bodylength.localeCompare(b.bodylength)"
        >
          <template slot-scope="record">
            <font v-if="record.bodylength != 0">
              {{ record.bodylength }}
            </font>
          </template>
        </a-table-column>
        <a-table-column title="TLS" key="tls" width="60px" align="center">
          <template slot-scope="record">
            <a-button
              v-if="record.tls !== '' && record.tls !== undefined"
              type="danger"
              ghost
              @click="showTLS(record.tls)"
            >
              TLS
            </a-button>
          </template>
        </a-table-column>
        <a-table-column title="ICP" key="icp" align="center">
          <template slot-scope="record">
            <a-button
              v-if="record.icp !== '' && record.icp !== undefined"
              type="danger"
              ghost
              @click="copyall(record.icp)"
            >
              {{ record.icp }}
            </a-button>
          </template>
        </a-table-column>
        <a-table-column
          title="CreateTime"
          key="createtime"
          align="center"
          width="200px"
        >
          <template slot-scope="record">
            {{ record.createtime }}
          </template>
        </a-table-column>
      </a-table>
    </a-card>
    <a-modal
      v-model="tls_show"
      :dialog-style="{ top: '20px' }"
      closable
      :footer="null"
      width="1400px"
      class="tls-show"
    >
      <p class="tls">{{ tls }}</p>
    </a-modal>
    <a-modal
      v-model="image_show"
      closable
      :dialog-style="{ top: '20px' }"
      :footer="null"
      :width="width - 40"
    >
      <img
        class="image-show"
        alt="screenshot"
        :src="image"
        style="height: 100%; width: 100%;"
      />
    </a-modal>
  </div>
</template>

<script>
import axios from 'axios'

export default {
  data() {
    return {
      tableHeight: window.innerHeight - 170, // body高度 - margin top 高度 - search栏高度 - 表头高度
      width: window.innerWidth, // body高度 - margin top 高度 - search栏高度 - 表头高度
      searchWord: '',
      datas: [],
      tls: '',
      tls_show: false,
      expandedRowKeys: [],
      searchModel: false,
      current: -1,

      image: '',
      image_show: false,

      pagination: {
        pageSize: 20, // 默认每页显示数量
        position: 'top',
        showSizeChanger: true, // 显示可改变每页数量
        pageSizeOptions: ['20', '40', '60', '80', '100'], // 每页数量选项
        showTotal: (total) => `Total ${total} items`, // 显示总数
        onShowSizeChange: (current, pageSize) => {
          this.sizeChange(current, pageSize)
        }, // 改变每页数量时更新显示
        total: 0,
        defaultCurrent: 1,
        onChange: this.change,
        current: 1,
      },
    }
  },
  // 适配屏幕
  created() {
    // 在create时创建，否则page还是1
    window.addEventListener('resize', this.getHeight)
  },
  destroyed() {
    window.addEventListener('resize', this.getHeight)
  },
  mounted() {
    this.getData(this.pagination.defaultCurrent, this.pagination.pageSize)

    window.addEventListener(
      'click',
      (e) => {
        console.log('click', e)
        if (e.target.className === 'image-show') {
          this.image_show = false
        }
      },
      false,
    )
    window.addEventListener(
      'dblclick',
      (e) => {
        console.log('dbclick', e)
        if (e.target.className === 'tls') {
          this.tls_show = false
        }
      },
      false,
    )
  },

  methods: {
    copy() {
      axios
        .post('/v1/copy', JSON.stringify({ word: this.searchWord }))
        .then((res) => {
          this.copyall(res.data)
        })
        .catch((err) => {
          this.$message.error(err.message)
          console.log(JSON.stringify(err))
        })
    },

    copyall(data) {
      const input = document.createElement('textarea')
      input.value = data
      document.body.appendChild(input)
      input.select()
      if (document.execCommand('copy')) {
        document.execCommand('copy')
      }
      document.body.removeChild(input)
      this.$message.success('copy success')
    },

    search() {
      if (!this.searchModel) {
        this.pagination.current = 1
      }
      if (this.current === this.pagination.current) {
        this.current = -1
        this.pagination.current = 1
      }
      this.searchModel = true
      axios
        .post(
          '/v1/search?page=' +
            this.pagination.current +
            '&flag=' +
            this.pagination.pageSize,
          JSON.stringify({ word: this.searchWord }),
        )
        .then((res) => {
          this.current = this.pagination.current
          this.datas = []
          this.pagination.total = res.data.total
          for (var i = 0; i < res.data.datas.length; i++) {
            this.expandedRowKeys.push(res.data.datas[i].id)
          }
          this.searchWord = res.data.query
          this.datas = res.data.datas
          this.$message.success('search data success')
        })
        .catch((err) => {
          this.$message.error(err.message)
          console.log(err)
        })
    },

    onExpand(expanded, record) {
      console.log('extend:' + expanded)
      console.log('record: ' + record.id)
      // 不允许关闭
      for (var i = 0; i < this.datas.length; i++) {
        this.expandedRowKeys.push(this.datas[i].id)
      }
    },

    change(id) {
      this.pagination.current = id
      if (this.searchModel) {
        this.search()
      } else {
        this.getData(id, this.pagination.pageSize)
      }
    },

    sizeChange(current, pageSize) {
      this.pagination.current = 1
      this.pagination.pageSize = pageSize
      if (this.searchModel) {
        this.search()
      } else {
        this.getData(this.pagination.defaultCurrent, this.pagination.pageSize)
      }
    },

    getData(page, flag) {
      axios
        .get('/v1/getdatas?page=' + page + '&flag=' + flag)
        .then((res) => {
          this.pagination.total = res.data.total
          for (var i = 0; i < res.data.datas.length; i++) {
            this.expandedRowKeys.push(res.data.datas[i].id)
          }
          this.datas = res.data.datas
          this.$message.success('load data success')
        })
        .catch((err) => {
          this.$message.error(err.message)
          console.log(err.status)
        })
      this.datas = []
    },

    getHeight() {
      this.tableHeight = window.innerHeight - 170
      this.width = window.innerWidth
    },

    showTLS(tls) {
      this.tls = tls
      this.tls_show = true
    },

    showScreenshot(img) {
      this.image = img
      this.image_show = true
    },
  },
}
</script>

<style>
.ant-table-pagination.ant-pagination {
  float: center !important;
  margin: 5px 0px !important;
}

.tls {
  height: 100%;
  width: 100%;
  overflow: auto;
  padding: 5px;
  border: 1px solid #e8e8e8;
  background-size: 100% 1.6em;
  display: block;
  /* 自动换行 */
  white-space: pre-wrap;
  /* css-3 */
  word-wrap: break-word;
  /* Internet Explorer 5.5+ */
  font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, Courier,
    monospace;
  margin: 0px;
  overflow-x: hidden;
}

.response {
  height: 345px;
  width: 100%;
  overflow: auto;
  padding: 5px;
  border: 1px solid #e8e8e8;
  background-size: 100% 1.6em;
  display: block;
  /* 自动换行 */
  white-space: pre-wrap;
  /* css-3 */
  word-wrap: break-word;
  /* Internet Explorer 5.5+ */
  font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, Courier,
    monospace;
  margin: 0px;
  overflow-x: hidden;
}
.urls {
  color: #585858;
}
a {
  text-decoration: none;
}
.url {
  max-height: 30px;
  overflow: auto;
  padding-left: 5px;
  padding-right: 5px;
  border: 1px solid #e8e8e8;
  background-size: 100% 1.6em;
  display: block;
  width: 99%;
  margin: 5px;
  font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, Courier,
    monospace;
  /* 隐藏水平滚动条 */
  overflow-x: hidden;
}
.expand-detail *:not(.internal-detail) .request {
  margin: 0px !important;
  margin-top: 2px !important;
}
.expand-detail *:not(.internal-detail) .response {
  margin: 0px !important;
  margin-top: 2px !important;
}
.expand-detail *:not(.internal-detail) pre {
  margin-left: 10px !important;
  margin-top: 2px !important;
  margin-bottom: 2px !important;
  margin-right: 10px !important;
}
.ant-descriptions-item-label {
  text-align: center !important;
  font-size: 25px !important;
  color: #585858 !important;
}
.ant-descriptions-bordered.ant-descriptions-middle .ant-descriptions-item-label,
.ant-descriptions-bordered.ant-descriptions-middle
  .ant-descriptions-item-content {
  padding: 3px;
}
.expand-detail :not(.internal-detail) .ant-descriptions-item-content {
  border-collapse: collapse !important;
  border-top: 1px solid #000000 !important;
  border-right: 1px solid #000000 !important;
  border-bottom: 1px solid #000000 !important;
}
.expand-detail :not(.internal-detail) .ant-descriptions-item-label {
  border-top: 1px solid #000000 !important;
  border-left: 1px solid #000000 !important;
  border-bottom: 1px solid #000000 !important;
  border-collapse: collapse !important;
}
.expand-detail *:not(.internal-detail) .ant-descriptions-item-content {
  border-collapse: collapse !important;
  border-left: 1px solid #000000 !important;
}
.expand-detail *:not(.internal-detail) .ant-descriptions-item-label {
  border-collapse: collapse !important;
  border-left: 1px solid #000000 !important;
}
.ant-table-thead > tr > th,
.ant-table-tbody > tr > td {
  padding: 8px 0px 8px 0px;
}

.ant-card-body {
  padding: 0px !important;
}
</style>
